{% extends "panel_details.html" %}
{% from "_file_macros.html" import filesTable, newFileModal %}
{% from "_macros.html" import notes_table_row, notes_table, metadata_table, note_editor, notes_table2 %}
{% import  "_details_macros.html" as widgets%}
{% import "_item_macros.html" as item_widgets %}
{% from "dialog_boxes.html" import newEntityModal, editNoteModal, newNoteModal, removeNoteModal, setupNoteTableJS %}
{% block main_details %}
    <div id="itemDetails" data-tyko-api-url="{{ url_for('api.item', item_id=item['item_id'] ) }}"></div>
    <div id="formatDetails" data-tyko-api-url="{{ url_for('api.item', item_id=item['item_id'] ) }}"></div>
    <div id="itemVendorDetails" data-tyko-api-url="{{ url_for('api.item', item_id=item['item_id'] ) }}"></div>
{% endblock %}

{% block secondary_details %}
    <div id="itemTreatmentDetails"
         data-tyko-api-treatment="{{ url_for('api.item_treatment', item_id=item['item_id'], object_id=object_id, project_id=project_id ) }}"
         data-tyko-api-url="{{ url_for('api.item', item_id=item['item_id'] ) }}"></div>
    <div id="itemFilesDetails"
         data-tyko-api-url="{{ url_for('api.item', item_id=item['item_id'] ) }}"
         data-tyko-api-files="{{ url_for('api.item_files', item_id=item['item_id'], object_id=object_id, project_id=project_id  ) }}"></div>
    {%  call widgets.card("Files", "my-1")  %}
        <div class="flex-column">

            <table id="filesTable"
                   class="tyko tyko-table-files"
                   aria-describedby="FilesHeader"
                   data-detail-formatter="detailFormatter"
                   data-cache="false"
                   data-sort-name="generation"
                   data-classes="table table-sm"
                   data-tyko-api-url="{{ api_path }}"
            >
                <thead>
                    <tr>
                        <th scope="col"
                            data-sortable="true"
                            data-width="100"
                            data-field="generation">Generation</th>
                        <th scope="col"
                            data-sortable="true"
                            data-width="1000"
                            data-formatter="fileNameFormatter"
                            data-field="name">File Name</th>
                        <th id="itemOptions"
                            scope="col"
                            data-width="10"
                            data-sortable="false"
                            data-formatter="fileOptionsFormatter"
                            data-field="routes"
                            data-align="right"></th>
                    </tr>
                </thead>
            </table>
        </div>
        <div>
            <div class="btn-group float-end" role="group">
                <button class="btn btn-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#newFileModal">Add</button>
            </div>
        </div>
    {{ widgets.confirm_remove_entity_modal2("removeFileModal") }}
    {% call newEntityModal('newFileModal', title="New File", submitUrl=url_for('site.item_new_file', item_id=item['item_id'], object_id=object_id, project_id=project_id), formId="newEndityForm") %}
        <div class="mb-3 row">
            <label for="objectNameInput" class="col-sm-2 col-form-label">File Name</label>
            <div class="col-sm-10">
                <input type="text" id="objectNameInput" class="form-control" name="file_name" required>
            </div>
        </div>
        <div class="mb-3 row">
            <label for="generationSelection" class="col-sm-2 col-form-label">Generation</label>
            <div class="col-sm-10">
                <select class="form-select" name="generation" id="generationSelection" required>
                    <option>Access</option>
                    <option>Preservation</option>
                    <option>Mezzanine</option>
                </select>
            </div>
        </div>
    {% endcall %}
    <script>
        let filesTable = document.getElementById('filesTable');

        filesTable.addEventListener(
            'openEntityDetails', (e)=>{window.location = e.detail}
        )

        document.getElementById('removeFileModal')
            .addEventListener('accept', (e)=> {
                fetch(e.detail.apiUrl, {method: 'DELETE'}).then(()=>{
                    console.log("accepted")
                    location.reload();
                }).catch((e)=>{console.error(`Failed to delete: "${e.detail.entityName}"`)})
            console.log("Deleting " + e.detail.entityName )
        })

        function fileNameFormatter(value, row, index) {
            return `<a href="${row.routes.frontend}">${value}</a>`
        }
        function fileOptionsFormatter(value, row, index) {
            const onEditFunction =
                'filesTable.dispatchEvent(' +
                    `new CustomEvent('openEntityDetails',
                        {detail: '${value.frontend}'}
                ))`;
            return `
                <div class="btn-group-sm d-flex justify-content-end" role="group" aria-label="Edit">
                <button class="btn btn-sm btn-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-haspopup="true"
                        aria-expanded="false"
                        ></button>
                <div class="dropdown-menu dropdown-menu-end">
                  <button class="btn btn-secondary btn-sm dropdown-item" onclick="${onEditFunction}">Edit</button>
                  <button class='btn btn-secondary btn-danger btn-sm dropdown-item' data-entity-name='${row.name}' data-removeurl='${value.api}' data-bs-target='#removeFileModal' data-bs-toggle='modal'>Remove</button>
                </div>
              </div>
                `
        }
        </script>
{#        {{ filesTable(api_path, item_id=item['item_id'], object_id=object_id, project_id=project_id) }}#}
{#        {{ newFileModal("fileModal", url_for('api.item_files', item_id=item['item_id'], object_id=object_id, project_id=project_id)) }}#}
    {% endcall %}

    {% call widgets.card("Notes", "mb-1")  %}
        <div class="flex-column" id="noteCard">
            {{
                notes_table2(
                    url_for(
                        "api.object_item",
                        project_id=project_id,
                        object_id=object_id,
                        item_id=item['item_id']
                        ),
                    table_id="notesTable"
                )
            }}
        </div>
        <div>
            <div class="btn-group float-end" role="group">
                <button
                    class="btn btn-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#newNote"
                    data-title="Create New Note"
                    data-dialogtype="new"
                    data-source="{{ note_api_route }}">
                    Add
                </button>
            </div>
        </div>
        {{ removeNoteModal(modalId="removeNoteModal") }}
        {{ newNoteModal(url_for('site.add_item_note', project_id=project_id, object_id=object_id, item_id=item['item_id']), modalId='newNote', formId='newNotesForm') }}
        {{ editNoteModal(url_for('site.update_item_note',project_id=project_id, object_id=object_id, item_id=item['item_id']), modalId="noteEditor") }}
        {{ setupNoteTableJS(notesTableId="notesTable", noteEditorId='noteEditor', newNoteId='newNote', newNotesFormId='newNotesForm', noteTypesUrl=url_for('api.note_types')) }}
    {% endcall %}

{% include "edit_note.html" %}
{% endblock %}
{% block scripts %}
    {{ super() }}
{% endblock %}